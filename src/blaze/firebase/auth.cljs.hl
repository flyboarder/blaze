(ns blaze.firebase.auth
  (:require [cljsjs.firebase]
            [firebase-cljs.core :as fb]
            [firebase-cljs.auth :as fbauth]
            [firebase-cljs.auth.error :as fbautherr]
            [firebase-cljs.auth.provider :as fbprov]
            [blaze.firebase :as bfb]))

(def ^:dynamic *facebook* (fbprov/facebook))

(def ^:dynamic *github-provider* (fbprov/github))

(def ^:dynamic *google-provider* (fbprov/google))

(def ^:dynamic *twitter-provider* (fbprov/twitter))

(fbprov/scope-email *google-provider* :google)
(fbprov/scope-email *github-provider* :github)
(fbprov/scope-email *facebook-provider* :facebook)

(fbprov/scope-profile *google-provider* :google)
(fbprov/scope-profile *github-provider* :github)
(fbprov/scope-profile *facebook-provider* :facebook)

(def ^:dynamic *pending-link* (cell nil))

(defn- handle-link
  [err]
  (let [cred (aget err "credential")
        email (aget err "email")
        pending {:cred cred :email email}]
    (.then
      (fbauth/providers-by-email bfb/*auth* email)
      #(reset! *pending-link*
        (assoc pending
          :providers (set %)
          :msg (fbautherr/message err))))))

(defn login!
  [provider & [auth]]
  (.catch
    (fbauth/login-popup (or auth bfb/*auth*) provider)
    #(case (keyword (fbautherr/code %))
      :auth/account-exists-with-different-credential (handle-link %)
      (throw (fbautherr/message %)))))

(defn logout! [& [auth]]
  (fbauth/logout (or auth bfb/*auth*)))

(defmethod do! :login
  [elem _ v]
  (do! :click #(login! v)))
